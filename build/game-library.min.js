/*! game-library 2014-02-18 */
(function(a){"use strict";var b;!function(a){var b=function(){function a(){}return a.guid=function(){var a=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},a.extend=function(a,b){b&&(a.prototype=Object.create(b.prototype))},a.matchData=function(b,c){var d=["$gt","$lt","$lte","$gte"],e="object"==typeof c&&d.some(function(a){return c[a]});if(e){var f=!0;return d.forEach(function(a){var d=c[a];if(d)switch(a){case"$gt":f=f&&b>d;break;case"$lt":f=f&&d>b;break;case"$gte":f=f&&b>=d;break;case"$lte":f=f&&d>=b}}),f}return typeof c!=typeof b?!1:"object"==typeof c?Object.keys(c).every(function(d){return a.matchData(b[d],c[d])},this):c===b},a}();a.Utils=b}(b||(b={}));var b;!function(a){var b=function(){function a(a,b,c){this.type=a,this.data=b,this.target=c}return a}();a.Event=b}(b||(b={}));var b;!function(a){var b=function(){function b(){this._subscribers=[],this._id=a.Utils.guid(),this._subjects={},this._listeners={}}return b.prototype.getId=function(){return this._id},b.prototype.fire=function(b,c,d){b instanceof a.Event?b.data=c||b.data:b=new a.Event(b,c),b.target=this,this._subscribers.forEach(function(a){a.notify(this._id,b,d)},this)},b.prototype.subscribe=function(a){this._subscribers.push(a)},b.prototype.unsubscribe=function(a){this._subscribers.forEach(function(b,c){return b===a?(this._subscribers.splice(c,1),!1):void 0},this)},b.prototype.destroy=function(){this._subscribers.forEach(function(a){a.remove(this)},this)},b.prototype.listen=function(a,b){var c=a.getId();this._subjects.hasOwnProperty(c)||(a.subscribe(this),this._subjects[c]=a),this._listeners[c]=b},b.prototype.notify=function(a,b,c){c=null==c?this:c,this._listeners.hasOwnProperty(a)&&this._listeners[a].bind(c)(b)},b.prototype.remove=function(a){var b=a.getId();if(this._subjects.hasOwnProperty(b)){var c=this._subjects[b];c.unsubscribe(this),delete this._listeners[b],delete this._subjects[b]}},b}();a.Messenger=b}(b||(b={}));var b,c=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};!function(a){var b=function(a){function b(){a.call(this)}return c(b,a),b.prototype.added=function(){this.fire("create",this)},b}(a.Messenger);a.GameObject=b}(b||(b={}));var b;!function(a){var b=function(){function a(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];this.name="GameError",a=a||"",this.message=a.replace(/{{(\d+)}}/g,function(a,c){return b[c-1]||""}),this.stack=(new Error).stack}return a.prototype.toString=function(){return this.name+": "+this.message},a.ErrorType={NOT_OBJECT:"You must call this method with a Game.Object instance.",ALREADY_ADDED:"Object already added to state.",NOT_ADDED:"Object was not added to state.",BAD_SCORE_DATA:"Score can only change by numerical amounts.",LEVEL_NOT_EXIST:"Specified level {{1}} does not exist.",REMOVE_CUR_LEVEL:"Cannot remove current level.",ADVANCE_CUR_LEVEL:"Cannot advance to current level."},a}();a.GameError=b}(b||(b={}));var b;!function(a){var b=function(b){function d(){b.call(this),this.objects={},this.eventCounters={},this.eventHandlers={},this.score=0}return c(d,b),d.prototype.onScore=function(b){if("number"!=typeof b.data)throw new a.GameError(a.GameError.ErrorType.BAD_SCORE_DATA);this.score+=b.data,b.target.fire("scoreChange",this.score)},d.prototype.onEvent=function(a){"score"===a.type&&this.onScore(a),this.eventCounters.hasOwnProperty(a.type)||(this.eventCounters[a.type]=[]),this.eventHandlers.hasOwnProperty(a.type)||(this.eventHandlers[a.type]=[]),this.eventCounters[a.type].push({time:new Date,data:a.data}),this.fire(a),this.eventHandlers[a.type].forEach(function(b){b(a)})},d.prototype.addObject=function(b){for(var c=[],d=0;d<arguments.length-1;d++)c[d]=arguments[d+1];if(!(b instanceof a.GameObject))throw new a.GameError(a.GameError.ErrorType.NOT_OBJECT);var e=b.getId();if(this.objects.hasOwnProperty(e))throw new a.GameError(a.GameError.ErrorType.ALREADY_ADDED);this.objects[e]=b,this.listen(b,this.onEvent),b.added.apply(b,c)},d.prototype.removeObject=function(b){if(!(b instanceof a.GameObject))throw new a.GameError(a.GameError.ErrorType.NOT_OBJECT);var c=b.getId();if(!this.objects.hasOwnProperty(c))throw new a.GameError(a.GameError.ErrorType.NOT_ADDED);delete this.objects[c],this.remove(b)},d.prototype.addEventHandler=function(a,b){this.eventHandlers.hasOwnProperty(a)||(this.eventHandlers[a]=[]),-1===this.eventHandlers[a].indexOf(b)&&this.eventHandlers[a].push(b)},d.prototype.removeEventHandler=function(a,b){this.eventHandlers.hasOwnProperty(a)&&this.eventHandlers[a].forEach(function(c,d){return c===b?(this.eventHandlers[a].splice(d,1),!1):void 0},this)},d}(a.Messenger);a.State=b}(b||(b={}));var b;!function(a){var b=function(a){function b(b){a.call(this),this.state=b,this.eventCounters={},this.init()}return c(b,a),b.prototype.init=function(){this.listen(this.state,this.onEvent)},b.prototype.onEvent=function(a){this.eventCounters.hasOwnProperty(a.type)||(this.eventCounters[a.type]=[]),this.eventCounters[a.type].push({time:new Date,data:a.data})},b}(a.Messenger);a.StateTracker=b}(b||(b={}));var b;!function(a){var b=function(b){function d(a){b.call(this,a),this.achievements={},this.achieved={}}return c(d,b),d.prototype.satisfied=function(b){if(!b.name)return!1;if(b.prereq&&!b.within)return!1;var c=b.name.match(/^a:(.+)$/);if(c)return this.hasAchieved(c[1]);if(!this.eventCounters.hasOwnProperty(b.name))return!1;var d=this.eventCounters[b.name],e=b.count&&b.count>0?b.count:1;if(b.data&&(d=d.filter(function(c){return a.Utils.matchData(c.data,b.data)},this)),b.within){var f=new Date;if(b.prereq){if(!this.eventCounters[b.prereq])return!1;f=this.eventCounters[b.prereq].slice(-1)[0].time}d=d.filter(function(a){return f.getTime()-a.time.getTime()<=b.within})}return d.length>=e},d.prototype.onEvent=function(a){b.prototype.onEvent.call(this,a),Object.keys(this.achievements).forEach(function(a){var b=this.achievements[a],c=b.every(this.satisfied,this);c&&(this.fire("achievement",{name:a,reqs:b}),this.achieved[a]=b,delete this.achievements[a])},this)},d.prototype.hasAchieved=function(a){return this.achieved.hasOwnProperty(a)},d.prototype.addAchievement=function(a,b){this.achievements[a]=b},d}(a.StateTracker);a.Achievements=b}(b||(b={}));var b;!function(a){var b=function(b){function d(){b.call(this)}return c(d,b),d.prototype.init=function(){this.state=new a.State,this.achievements=new a.Achievements(this.state)},d}(a.Messenger);a.Application=b}(b||(b={}));var b;!function(a){var b=function(b){function d(a){b.call(this,a),this.currentLevel=0}return c(d,b),d.prototype.addLevel=function(a,b,c){return this.levels.push({data:a,goals:b||[],effects:c||[]}),this.levels.length-1},d.prototype.removeLevel=function(b){if(0>b||b>=this.levels.length)throw new a.GameError(a.GameError.ErrorType.LEVEL_NOT_EXIST,b);if(b===this.currentLevel)throw new a.GameError(a.GameError.ErrorType.REMOVE_CUR_LEVEL);this.levels.splice(b,1),b<this.currentLevel&&(this.currentLevel-=1)},d.prototype.addGoals=function(b,c){if(0>c||c>=this.levels.length)throw new a.GameError(a.GameError.ErrorType.LEVEL_NOT_EXIST,c);c=c||this.currentLevel,this.levels[c].goals.push.apply(this.levels[c].goals,b)},d.prototype.addEffects=function(b,c){if(0>c||c>=this.levels.length)throw new a.GameError(a.GameError.ErrorType.LEVEL_NOT_EXIST,c);c=c||this.currentLevel,this.levels[c].effects.push.apply(this.levels[c].effects,b)},d.prototype.advance=function(b){if(b=b||this.currentLevel+1,0>b||b>=this.levels.length)throw new a.GameError(a.GameError.ErrorType.LEVEL_NOT_EXIST,b);if(b===this.currentLevel)throw new a.GameError(a.GameError.ErrorType.ADVANCE_CUR_LEVEL);this.currentLevel=b,this.fire("advance",this.currentLevel)},d.prototype.satisfied=function(b){if(!b.name)return!1;if(b.prereq&&!b.within)return!1;if(!this.eventCounters.hasOwnProperty(b.name))return!1;var c=this.eventCounters[b.name],d=b.count&&b.count>0?b.count:1;if(b.data&&(c=c.filter(function(c){return a.Utils.matchData(c.data,b.data)},this)),b.within){var e=new Date;if(b.prereq){if(!this.eventCounters[b.prereq])return!1;e=this.eventCounters[b.prereq].slice(-1)[0].time}c=c.filter(function(a){return e.getTime()-a.time.getTime()<=b.within})}return c.length>=d},d.prototype.onEvent=function(a){b.prototype.onEvent.call(this,a);var c=this.levels[this.currentLevel].goals.every(this.satisfied,this);c&&(this.fire("levelCompleted",this.currentLevel),this.eventCounters={})},d}(a.StateTracker);a.Plot=b}(b||(b={})),a.Game=b}).bind(this)(this);