/*! game-library 2014-02-09 */
(function(a){"use strict";var b;!function(a){var b=function(){function a(a,b,c){this.type=a,this.data=b,this.target=c}return a}();a.Event=b}(b||(b={}));var b;!function(a){var b=function(){function a(){}return a.guid=function(){var a=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},a.extend=function(a,b){b&&(a.prototype=Object.create(b.prototype))},a}();a.Utils=b}(b||(b={}));var b;!function(a){var b=function(){function b(){this._subscribers=[],this._id=a.Utils.guid(),this._subjects={},this._listeners={}}return b.prototype.getId=function(){return this._id},b.prototype.fire=function(b,c,d){b instanceof a.Event?b.data=c||b.data:b=new a.Event(b,c),b.target=this,this._subscribers.forEach(function(a){a.notify(this._id,b,d)},this)},b.prototype.subscribe=function(a){this._subscribers.push(a)},b.prototype.unsubscribe=function(a){this._subscribers.forEach(function(b,c){return b===a?(this._subscribers.splice(c,1),!1):void 0},this)},b.prototype.destroy=function(){this._subscribers.forEach(function(a){a.remove(this)},this)},b.prototype.listen=function(a,b){var c=a.getId();this._subjects.hasOwnProperty(c)||(a.subscribe(this),this._subjects[c]=a),this._listeners[c]=b},b.prototype.notify=function(a,b,c){c=null==c?this:c,this._listeners.hasOwnProperty(a)&&this._listeners[a].bind(c)(b)},b.prototype.remove=function(a){var b=a.getId();if(this._subjects.hasOwnProperty(b)){var c=this._subjects[b];c.unsubscribe(this),delete this._listeners[b],delete this._subjects[b]}},b}();a.Messenger=b}(b||(b={}));var b,c=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};!function(a){var b=function(a){function b(){a.call(this)}return c(b,a),b.prototype.added=function(){this.fire("create",this)},b}(a.Messenger);a.GameObject=b}(b||(b={}));var b;!function(a){var b=function(){function a(a){this.name="GameError",this.message=a,this.stack=(new Error).stack}return a.prototype.toString=function(){return this.name+": "+this.message},a.ErrorType={NOT_OBJECT:"You must call this method with a Game.Object instance.",ALREADY_ADDED:"Object already added to state.",NOT_ADDED:"Object was not added to state.",BAD_SCORE_DATA:"Score can only change by numerical amounts."},a}();a.GameError=b}(b||(b={}));var b;!function(a){var b=function(b){function d(){b.call(this),this.objects={},this.eventCounters={},this.eventHandlers={},this.score=0}return c(d,b),d.prototype.onScore=function(b){if("number"!=typeof b.data)throw new a.GameError(a.GameError.ErrorType.BAD_SCORE_DATA);this.score+=b.data,b.target.fire("scoreChange",this.score)},d.prototype.onEvent=function(a){"score"===a.type&&this.onScore(a),this.eventCounters.hasOwnProperty(a.type)||(this.eventCounters[a.type]=[]),this.eventHandlers.hasOwnProperty(a.type)||(this.eventHandlers[a.type]=[]),this.eventCounters[a.type].push({time:new Date,data:a.data}),this.fire(a),this.eventHandlers[a.type].forEach(function(b){b(a)})},d.prototype.addObject=function(b){for(var c=[],d=0;d<arguments.length-1;d++)c[d]=arguments[d+1];if(!(b instanceof a.GameObject))throw new a.GameError(a.GameError.ErrorType.NOT_OBJECT);var e=b.getId();if(this.objects.hasOwnProperty(e))throw new a.GameError(a.GameError.ErrorType.ALREADY_ADDED);this.objects[e]=b,this.listen(b,this.onEvent),b.added.apply(b,c)},d.prototype.removeObject=function(b){if(!(b instanceof a.GameObject))throw new a.GameError(a.GameError.ErrorType.NOT_OBJECT);var c=b.getId();if(!this.objects.hasOwnProperty(c))throw new a.GameError(a.GameError.ErrorType.NOT_ADDED);delete this.objects[c],this.remove(b)},d.prototype.addEventHandler=function(a,b){this.eventHandlers.hasOwnProperty(a)||(this.eventHandlers[a]=[]),-1===this.eventHandlers[a].indexOf(b)&&this.eventHandlers[a].push(b)},d.prototype.removeEventHandler=function(a,b){this.eventHandlers.hasOwnProperty(a)&&this.eventHandlers[a].forEach(function(c,d){return c===b?(this.eventHandlers[a].splice(d,1),!1):void 0},this)},d}(a.Messenger);a.State=b}(b||(b={}));var b;!function(a){var b=function(a){function b(b){a.call(this),this.state=b,this.achievements={},this.achieved={},this.init()}return c(b,a),b.prototype.init=function(){this.listen(this.state,this.onEvent)},b.prototype.matchData=function(a,b){var c=["$gt","$lt","$lte","$gte"],d="object"==typeof b&&c.some(function(a){return b[a]});if(d){var e=!0;return c.forEach(function(c){var d=b[c];if(d)switch(c){case"$gt":e=e&&a>d;break;case"$lt":e=e&&d>a;break;case"$gte":e=e&&a>=d;break;case"$lte":e=e&&d>=a}}),e}return typeof b!=typeof a?!1:"object"==typeof b?Object.keys(b).every(function(c){return this.matchData(a[c],b[c])},this):b===a},b.prototype.satisfied=function(a){if(!a.name)return!1;if(a.prereq&&!a.within)return!1;var b=a.name.match(/^a:(.+)$/);if(b)return this.hasAchieved(b[1]);if(!this.state.eventCounters.hasOwnProperty(a.name))return!1;var c=this.state.eventCounters[a.name],d=a.count&&a.count>0?a.count:1;if(a.data&&(c=c.filter(function(b){return this.matchData(b.data,a.data)},this)),a.within){var e=new Date;if(a.prereq){if(!this.state.eventCounters[a.prereq])return!1;e=this.state.eventCounters[a.prereq].slice(-1)[0].time}c=c.filter(function(b){return e.getTime()-b.time.getTime()<=a.within})}return c.length>=d},b.prototype.onEvent=function(){Object.keys(this.achievements).forEach(function(a){var b=this.achievements[a],c=b.every(this.satisfied,this);c&&(this.fire("achievement",{name:a,reqs:b}),this.achieved[a]=b,delete this.achievements[a])},this)},b.prototype.hasAchieved=function(a){return this.achieved.hasOwnProperty(a)},b.prototype.addAchievement=function(a,b){this.achievements[a]=b},b}(a.Messenger);a.Achievements=b}(b||(b={}));var b;!function(a){var b=function(b){function d(){b.call(this)}return c(d,b),d.prototype.init=function(){this.state=new a.State,this.achievements=new a.Achievements(this.state)},d}(a.Messenger);a.Application=b}(b||(b={})),a.Game=b}).bind(this)(this);